<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Time-Dependent Propensity Score Matching — method_psm • MatchTime</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Time-Dependent Propensity Score Matching — method_psm"><meta name="description" content='This documentation page describes the matching process used when setting method="psm" in the match_time function and gives a detailed explanation on the supported additional arguments in this case.'><meta property="og:description" content='This documentation page describes the matching process used when setting method="psm" in the match_time function and gives a detailed explanation on the supported additional arguments in this case.'><meta property="og:image" content="https://robindenz1.github.io/MatchTime/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">MatchTime</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/MatchTime.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/creating_start_stop_data.html">Creating and Dealing with Start-Stop Data in R</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/RobinDenz1/MatchTime/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Time-Dependent Propensity Score Matching</h1>

      <div class="d-none name"><code>method_psm.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This documentation page describes the matching process used when setting <code>method="psm"</code> in the <code><a href="match_time.html">match_time</a></code> function and gives a detailed explanation on the supported additional arguments in this case.</p>
    </div>


    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <p></p>
<dl><dt id="arg-formula-ps">formula_ps<a class="anchor" aria-label="anchor" href="#arg-formula-ps"></a></dt>
<dd><p>An optional formula object, specifying the right-hand side of the formula that should be used for the propensity score model, or <code>NULL</code> (default). If <code>NULL</code>, the right-hand side of the <code>formula</code> argument is used to fit the model. This argument is useful mostly to specify interactions, non-linear effects or similar thing. Note that this formula object should start with <code>~</code> and have nothing on the left-hand side.</p></dd>

  <dt id="arg-ps-type">ps_type<a class="anchor" aria-label="anchor" href="#arg-ps-type"></a></dt>
<dd><p>A single character string, specifying which type of "propensity score" to use. Currently supports <code>"ps"</code>, which results in usage of the actual hazard of treatment at time \(t\) and <code>"lp"</code>, which instead uses only the linear predictor of the model (disregarding the baseline hazard), as proposed by Hade et al. (2015). Using <code>"lp"</code> is faster because the baseline hazard does not need to be estimated and because there is no need to calculate the actual hazard each time where matching is done. See details.</p></dd>

  <dt id="arg-standardize-ps">standardize_ps<a class="anchor" aria-label="anchor" href="#arg-standardize-ps"></a></dt>
<dd><p>Either <code>TRUE</code> or <code>FALSE</code> (default), specifying whether to standardize the "propensity score" as specified by <code>ps_type</code> to the 0 / 1 range. This might be beneficial for some matching strategies and was, for example, used in Richey et al. (2024).</p></dd>

  <dt id="arg-basehaz-interpol">basehaz_interpol<a class="anchor" aria-label="anchor" href="#arg-basehaz-interpol"></a></dt>
<dd><p>A single character string controlling how the estimated baseline hazard should be interpolated. This is only used when <code>type_ps="ps"</code>, in which case the baseline hazard is estimated from the fitted propensity score Cox model using the <code><a href="https://rdrr.io/pkg/survival/man/basehaz.html" class="external-link">basehaz</a></code> function from the <span class="pkg">survival</span> package. Allowed values are <code>"constant"</code> (default) for step function interpolation (as usual for survival curves) or <code>"linear"</code> for linear interpolation. Should usually be kept at <code>"constant"</code>. Interpolation is performed internally using the <code><a href="https://rdrr.io/r/stats/approxfun.html" class="external-link">approxfun</a></code> function with <code>rule=2</code>.</p></dd>

  <dt id="arg-remove-ps">remove_ps<a class="anchor" aria-label="anchor" href="#arg-remove-ps"></a></dt>
<dd><p>Either <code>TRUE</code> or <code>FALSE</code> (default), specifying whether the estimated propensity score should be removed from <code>data</code>. If <code>FALSE</code>, the propensity score at <code>.treat_time</code> is included in the <code>.ps_score</code> column.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>


<p>All arguments of the <code><a href="match_time.html">match_time</a></code> function may be used when using <code>method="psm"</code>, because of the general sequential nature of the matching. The only difference in the matching process is that matching is not performed directly on the covariates in <code>formula</code>, but instead is done only on an estimated time-dependent propensity score at each point in time.</p>
<p><strong><em>How it works</em></strong>:</p>
<p>The propensity score is usually defined as the probability that an individual receives the treatment. In the case of a time-dependent treatment, the propensity score is instead defined as the probability that an individual receives the treatment at time t, given that the individual has not yet received the treatment up to this point. This is equivalent to the <em>survival probability</em>, only that the outcome is the treatment of interest, not the outcome of interest. By matching individuals only on this score instead of on the covariates directly, the groups will be balanced over all points in time (Lu 2005).</p>
<p><strong><em>Estimation of the Propensity Score</em></strong>:</p>
<p>The "propensity score" is estimated using a Cox model with the treatment variable as dependent variable in the first step. In practice, the hazard of receiving the treatment is then calculated for all individuals at each point where matching is performed. Although this is technically not the same as a regular propensity score, because it is not an actual probability between 0 and 1, it is referred to as the time-dependent propensity score in the literature. The matching is then done entirely using this propensity score, ignoring all other covariates. This may in some cases be a faster alternative than matching on many covariates at the same time. The model used to predict the propensity scores is included in the output object whenever <code>method="psm"</code> is used.</p>
<p>Formally, following the Cox model, the hazard of receiving treatment \(A\) is given by:</p>
<p>$$h_A(t) = h_{A0}(t) e^{\beta X(t)},$$</p>
<p>where \(h_{A0}(t)\) is the baseline hazard and \(X(t)\) stands for an arbitrary amount of (possibly) time-dependent covariates. By default (<code>ps_type="ps"</code>), the estimated hazard of treatment at \(t\) \(\left(\hat{h}_{A}(t)\right)\) is used in matching. Internally, the <code><a href="https://rdrr.io/pkg/survival/man/basehaz.html" class="external-link">basehaz</a></code> function is simply called on the Cox model to estimate \(h_{A0}(t)\). If there are no <code><a href="https://rdrr.io/pkg/survival/man/strata.html" class="external-link">strata</a></code> terms in the <code>formula</code> used to fit this model, the baseline hazard will be the same for all individuals at \(t\), in which case it would be equivalent to use <code>ps_type="lp"</code>, in which case only the linear predictor \(\left(e^{\beta X(t)}\right)\) is used for matching.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Lu, Bo (2005). "Propensity Score Matching with Time-Dependent Covariates". In: Biometrics 61.3, pp. 721-728.</p>
<p>Hade, Erinn M., Giovannie Nattino, Heather A. Frey, and Bo Lu (2020). "Propensity Score Matching for Treatment Delay Effects with Observational Survival Data". In: Statistical Methods in Medical Research 29.3, pp. 695-708.</p>
<p>Richey, Morgan, Matthew Mayiejewski, Lindsay Tepel, David Arterburn, Aniket Kawatkar, Caroline E. Sloan, and Valerie A. Smith (2024). "A Comparison of Time-Varying Propensity Score vs Sequential Stratification Approaches to Longitudinal Matching with a Time-Varying Treatment". In: BMC Medical Research Methodology 24.280.</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Robin Denz</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RobinDenz1/MatchTime" class="external-link">MatchTime</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"survival"</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"MatchIt"</span><span class="op">)</span> <span class="op">&amp;</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"ggplot2"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kosukeimai.github.io/MatchIt/" class="external-link">MatchIt</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># load some example data from the survival package</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"heart"</span>, package<span class="op">=</span><span class="st">"survival"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># keep only columns relevant for matching</span></span></span>
<span class="r-in"><span><span class="va">heart</span> <span class="op">&lt;-</span> <span class="va">heart</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"start"</span>, <span class="st">"stop"</span>, <span class="st">"transplant"</span>, <span class="st">"age"</span>, <span class="st">"surgery"</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## time-dependent propensity score matching, using "transplant" as treatment</span></span></span>
<span class="r-in"><span><span class="co">## and surgery + age as variables to match on</span></span></span>
<span class="r-in"><span><span class="va">m.obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="match_time.html">match_time</a></span><span class="op">(</span><span class="va">transplant</span> <span class="op">~</span> <span class="va">surgery</span> <span class="op">+</span> <span class="va">age</span>, data<span class="op">=</span><span class="va">heart</span>, id<span class="op">=</span><span class="st">"id"</span>,</span></span>
<span class="r-in"><span>                    method<span class="op">=</span><span class="st">"psm"</span>, match_method<span class="op">=</span><span class="st">"nearest"</span>,</span></span>
<span class="r-in"><span>                    replace_over_t<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># showing a summary of the used propensity score model</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m.obj</span><span class="op">$</span><span class="va">ps_model</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: algorithm did not converge</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: algorithm did not converge</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: algorithm did not converge</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: algorithm did not converge</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: algorithm did not converge</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: algorithm did not converge</span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>glm.fit: fitted probabilities numerically 0 or 1 occurred</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Call:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> survival::coxph(formula = stats::as.formula(cox_form), data = d_ps_mod)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   n= 69, number of events= 69 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    (34 observations deleted due to missingness)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>               coef  exp(coef)   se(coef)      z Pr(&gt;|z|)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> surgery -0.3621390  0.6961856  0.3105484 -1.166    0.244</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> age      0.0008046  1.0008049  0.0143960  0.056    0.955</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         exp(coef) exp(-coef) lower .95 upper .95</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> surgery    0.6962     1.4364    0.3788     1.280</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> age        1.0008     0.9992    0.9730     1.029</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Concordance= 0.549  (se = 0.039 )</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Likelihood ratio test= 1.46  on 2 df,   p=0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Wald test            = 1.36  on 2 df,   p=0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Score (logrank) test = 1.38  on 2 df,   p=0.5</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Robin Denz.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

